/*
 * temperature.c
 *
 *  Created on: Jun 11, 2025
 *      Author: user
 */

#include "temperature.h"

// Look Up Table
// CTRL + A, CTRL + SHIFT + F
const float temperatures[] = { -39.44, -38.33, -37.22, -36.11, -35, -33.89,
		-32.78, -31.67, -30.56, -29.44, -28.33, -27.22, -26.11, -25, -23.89, -22.78,
		-21.67, -20.56, -19.44, -18.33, -17.22, -16.11, -15, -13.89, -12.78, -11.67,
		-10.56, -9.44, -8.33, -7.22, -6.11, -5, -3.89, -2.78, -1.67, -0.56, 0.56,
		1.67, 2.78, 3.89, 5, 6.11, 7.22, 8.33, 9.44, 10.56, 11.67, 12.78, 13.89, 15,
		16.11, 17.22, 18.33, 19.44, 20.56, 21.67, 22.78, 23.89, 25, 26.11, 27.22,
		28.33, 29.44, 30.56, 31.67, 32.78, 33.89, 35, 36.11, 37.22, 38.33, 39.44,
		40.56, 41.67, 42.78, 43.89, 45, 46.11, 47.22, 48.33, 49.44, 50.56, 51.67,
		52.78, 53.89, 55, 56.11, 57.22, 58.33, 59.44, 60.56, 61.67, 62.78, 63.89,
		65, 66.11, 67.22, 68.33, 69.44, 70.56, 71.67, 72.78, 73.89, 75, 76.11,
		77.22, 78.33, 79.44, 80.56, 81.67, 82.78, 83.89, 85, 86.11 };

const float resistances[] = { 323839, 300974, 279880, 260410, 242427, 225809,
		210443, 196227, 183068, 170775, 159488, 149024, 139316, 130306, 121939,
		114165, 106939, 100218, 93909, 88090, 82670, 77620, 72911, 68518, 64419,
		60592, 57017, 53647, 50526, 47606, 44874, 42317, 39921, 37676, 35573, 33599,
		31732, 29996, 28365, 26834, 25395, 24042, 22770, 21573, 20446, 19376, 18378,
		17437, 16550, 15714, 14925, 14180, 13478, 12814, 12182, 11590, 11030, 10501,
		10000, 9526, 9078, 8653, 8251, 7866, 7505, 7163, 6838, 6530, 6238, 5960,
		5697, 5447, 5207, 4981, 4766, 4561, 4367, 4182, 4006, 3838, 3679, 3525,
		3380, 3242, 3111, 2985, 2865, 2751, 2642, 2538, 2438, 2343, 2252, 2165,
		2082, 2003, 1927, 1855, 1785, 1718, 1655, 1594, 1536, 1480, 1427, 1375,
		1326, 1279, 1234, 1190, 1149, 1109, 1070, 1034 };

// ADC Value를 입력 받아 온도를 계산
float lookupTemperature(uint16_t adcValue) {
	const float Vcc = 3.3;
	const float R1 = 10000;
	float Vo;	// 서미스터의 전압값
	float R2;	// 서미스터의 저항값
	float temperature;

	// ADC값으로부터 전압 계산 (12bit adc = 0 ~ 4095)
	Vo = ((float)adcValue * Vcc) / 4095.0;
	// Vo를 이용하여 서미스터의 현재 저항값을 계산
	R2 = R1 / ((Vcc / Vo) - 1.0);

	// 테이블의 크기를 계산
	const int tableSize = sizeof(temperatures) / sizeof(temperatures[0]);

	// LUT에서 해당 저항값의 위치를 찾고, 그 위치에 해당하는 온도 값을 꺼내옴
	for(int i = 0; i < tableSize - 1; i++) {
		if (R2 <= resistances[i] && R2 > resistances[i+1]) {
			// 선형 보간을 사용하여 온도를 계산
			float slope = (temperatures[i+1] - temperatures[i]) / (resistances[i+1] - resistances[i]);
			temperature = temperatures[i] + slope * (R2 - resistances[i]);
			break;
		}
	}
	return temperature;
}
